<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Duyuru Ekle - Nova Sigorta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar { min-height: 100vh; background-color: #343a40; color: white; }
        .sidebar a { color: #cfd8dc; text-decoration: none; padding: 15px; display: block; }
        .sidebar a:hover, .sidebar a.active { background-color: #0d6efd; color: white; }
    </style>
</head>
<body>

<div class="d-flex">
    <div class="sidebar p-3" style="width: 250px;">
        <h4 class="text-center mb-4">Nova Panel</h4>
        
        <a href="admin-dashboard.html"><i class="fa fa-chart-line me-2"></i> Özet Paneli</a>
        <a href="admin-duyuru.html" class="active"><i class="fa fa-bullhorn me-2"></i> Duyuru Ekle</a>
        <a href="admin-mesajlar.html"><i class="fa fa-envelope me-2"></i> Gelen Kutusu</a>
        
        <hr>
        <a href="../index.html" class="text-danger"><i class="fa fa-sign-out-alt me-2"></i> Çıkış Yap</a>
    </div>

    <div class="flex-grow-1 bg-light p-4">
        <h2 class="mb-4">Yeni Duyuru Ekle</h2>
        <div class="card">
            <div class="card-body">
                
                <form id="duyuruForm">
                    <div class="mb-3">
                        <label class="form-label">Duyuru Başlığı</label>
                        <input type="text" id="duyuruBaslik" class="form-control" placeholder="Başlık giriniz" required>
                    </div>

                    <div class="mb-3">                                   
                        <label class="form-label">Kategori</label>
                        <select id="duyuruKategori" class="form-select">
                            <option value="Kampanya">Kampanya</option>
                            <option value="Haber">Haber</option>                            
                            <option value="Duyuru">Duyuru</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Dosya Ekle (PDF, Docx, Png)</label>
                        <input type="file" id="duyuruDosya" class="form-control" accept=".pdf, .doc, .docx, .png, .jpg, .jpeg">
                        <div class="form-text">Maksimum dosya boyutu: 5MB (Simülasyon)</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">İçerik Detayı</label>
                        <textarea id="duyuruIcerik" class="form-control" rows="5" placeholder="Detaylar" required></textarea>
                    </div>

                    <button type="submit" class="btn btn-success"><i class="fa fa-save me-2"></i> Yayınla</button>
                    <a href="admin-dashboard.html" class="btn btn-secondary">İptal</a>
                </form>

            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('duyuruForm').addEventListener('submit', function(e) {
        e.preventDefault(); 
        
        const baslik = document.getElementById('duyuruBaslik').value;
        const kategori = document.getElementById('duyuruKategori').value;
        const icerik = document.getElementById('duyuruIcerik').value;
        const dosyaInput = document.getElementById('duyuruDosya'); 
        const tarih = new Date().toLocaleDateString('tr-TR');

        // Dosya okuyucu oluşturuyoruz
        const reader = new FileReader();

        // Varsayılan resim (Eğer resim seçmezsen bu görünür)
        let resimData = '../img/blog-1.png'; 
        let dosyaAdi = "";
        let dosyaTipi = "";

        // Eğer kullanıcı bir dosya seçtiyse
        if (dosyaInput.files.length > 0) {
            const file = dosyaInput.files[0];
            dosyaAdi = file.name;

            // Dosya tipini belirle (ikon için)
            if (dosyaAdi.endsWith('.pdf')) { dosyaTipi = 'pdf'; }
            else if (dosyaAdi.endsWith('.doc') || dosyaAdi.endsWith('.docx')) { dosyaTipi = 'word'; }
            else if (dosyaAdi.match(/\.(jpg|jpeg|png)$/i)) { dosyaTipi = 'image'; }
            else { dosyaTipi = 'file'; }

            // Resmi okumaya başla
            reader.readAsDataURL(file);
        } else {
            // Resim seçilmediyse direkt kaydet
            kaydetVeBitir(baslik, kategori, icerik, tarih, resimData, dosyaAdi, dosyaTipi);
        }

        // Okuma bitince çalışacak fonksiyon (Asıl işlem burada)
        reader.onload = function () {
            // Eğer yüklenen dosya bir resimse, onu kapak resmi yap
            if (dosyaTipi === 'image') {
                resimData = reader.result; // Resmin kodlanmış hali (Base64)
            }
            kaydetVeBitir(baslik, kategori, icerik, tarih, resimData, dosyaAdi, dosyaTipi);
        };

        function kaydetVeBitir(baslik, kat, icerik, tar, img, dAdi, dTipi) {
            const yeniKayit = {
                id: Date.now(),
                baslik: baslik,
                kategori: kat,
                icerik: icerik,
                tarih: tar,
                resim: img, // Artık seçilen resim buraya gidiyor
                dosyaAdi: dAdi,
                dosyaTipi: dTipi
            };

            // LocalStorage işlemlerini yap (Hata önleyici try-catch ekledim)
            try {
                let duyurular = JSON.parse(localStorage.getItem('tumDuyurular')) || [];
                duyurular.unshift(yeniKayit);
                localStorage.setItem('tumDuyurular', JSON.stringify(duyurular));
                
                alert('Duyuru başarıyla eklendi!');
                window.location.href = '../index.html';
            } catch (error) {
                alert("Hata: Resim boyutu çok büyük! Lütfen daha küçük (KB boyutunda) bir resim seçin.");
                console.error(error);
            }
        }
    });
</script>

</body>
</html>